<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Chat WebSocket</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #4CAF50;
    }
    input, button, textarea {
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    input {
      width: calc(100% - 22px);
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px 20px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #logs {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 4px;
      height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .status {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 5px;
    }
    .status.connected {
      background: #4CAF50;
    }
    .status.disconnected {
      background: #f44336;
    }
    .info {
      background: #e3f2fd;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      border-left: 4px solid #2196F3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”Œ Test Chat WebSocket - Study Together</h1>
    
    <div class="info">
      <strong>ğŸ“‹ HÆ°á»›ng dáº«n Test Nhanh:</strong><br>
      1. Nháº­p JWT token (láº¥y tá»« Ä‘Äƒng nháº­p) â†’ Click "Connect"<br>
      2. Nháº­p User ID cá»§a 2 users â†’ Click "Create Test Chat"<br>
      3. Chat ID sáº½ tá»± Ä‘á»™ng Ä‘iá»n â†’ Click "Join Chat"<br>
      4. Gá»­i message vÃ  xem real-time!<br>
      5. Sau khi test xong â†’ Click "Cleanup Test Data" Ä‘á»ƒ dá»n dáº¹p
    </div>

    <!-- Connection Section -->
    <div class="section">
      <h3>
        <span class="status" id="status"></span>
        Káº¿t ná»‘i WebSocket
      </h3>
      <input 
        type="text" 
        id="jwtToken" 
        placeholder="Nháº­p JWT Token (tá»« /auth/login)"
      >
      <button onclick="connect()" id="connectBtn">Connect</button>
      <button onclick="disconnect()" id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <!-- Create Chat Section -->
    <div class="section">
      <h3>ğŸ†• Táº¡o Chat (User 1 lÃ m)</h3>
      <input 
        type="text" 
        id="user1Id" 
        placeholder="User 1 ID (your ID)"
      >
      <input 
        type="text" 
        id="user2Id" 
        placeholder="User 2 ID (friend's ID)"
      >
      <button onclick="createPrivateChat()" disabled class="action-btn">Create Private Chat</button>
      <p style="color: #666; font-size: 12px; margin: 5px 0;">
        ğŸ’¡ User 1 táº¡o chat â†’ Copy Chat ID â†’ Gá»­i cho User 2 â†’ User 2 paste vÃ o Ã´ "Chat ID" bÃªn dÆ°á»›i
      </p>
    </div>

    <!-- Chat Actions -->
    <div class="section">
      <h3>ğŸ’¬ Join Chat & Actions</h3>
      
      <input 
        type="text" 
        id="chatId" 
        placeholder="Chat ID (paste tá»« User 1 náº¿u báº¡n lÃ  User 2)"
      >
      <input 
        type="text" 
        id="userId" 
        placeholder="Your User ID"
      >
      
      <div style="margin-top: 10px;">
        <button onclick="joinChat()" disabled class="action-btn">Join Chat</button>
        <button onclick="leaveChat()" disabled class="action-btn">Leave Chat</button>
        <button onclick="sendTyping()" disabled class="action-btn">Typing</button>
        <button onclick="stopTyping()" disabled class="action-btn">Stop Typing</button>
      </div>
    </div>

    <!-- REST API Section -->
    <div class="section">
      <h3>ğŸ“¡ Test REST API (Gá»­i Message)</h3>
      
      <textarea 
        id="messageContent" 
        placeholder="Ná»™i dung message"
        rows="3"
        style="width: calc(100% - 22px);"
      ></textarea>
      
      <button onclick="sendMessage()" disabled class="action-btn">Send Message (POST /api/messages)</button>
    </div>

    <!-- Logs -->
    <div class="section">
      <h3>ğŸ“ Logs</h3>
      <button onclick="clearLogs()">Clear Logs</button>
      <div id="logs"></div>
    </div>
  </div>

  <script>
    let socket = null;
    const logsDiv = document.getElementById('logs');
    const statusDiv = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const actionBtns = document.querySelectorAll('.action-btn');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        info: '#00ff00',
        error: '#ff4444',
        success: '#00ff00',
        warning: '#ffaa00'
      };
      
      logsDiv.innerHTML += `<span style="color: ${colors[type]}">[${timestamp}] ${message}</span>\n`;
      logsDiv.scrollTop = logsDiv.scrollHeight;
    }

    function updateStatus(connected) {
      statusDiv.className = connected ? 'status connected' : 'status disconnected';
      connectBtn.disabled = connected;
      disconnectBtn.disabled = !connected;
      actionBtns.forEach(btn => btn.disabled = !connected);
    }

    function connect() {
      const token = document.getElementById('jwtToken').value.trim();
      
      if (!token) {
        alert('Vui lÃ²ng nháº­p JWT token!');
        return;
      }

      log('ğŸ”„ Äang káº¿t ná»‘i WebSocket...', 'info');

      socket = io('http://localhost:3000/chat', {
        extraHeaders: {
          Authorization: `Bearer ${token}`
        },
        transports: ['websocket', 'polling']
      });

      // Connection events
      socket.on('connect', () => {
        log('âœ… Káº¿t ná»‘i thÃ nh cÃ´ng! Socket ID: ' + socket.id, 'success');
        updateStatus(true);
      });

      socket.on('disconnect', (reason) => {
        log('âŒ Ngáº¯t káº¿t ná»‘i. LÃ½ do: ' + reason, 'error');
        updateStatus(false);
      });

      socket.on('connect_error', (error) => {
        log('âŒ Lá»—i káº¿t ná»‘i: ' + error.message, 'error');
        updateStatus(false);
      });

      // Chat events
      socket.on('chatHistory', (data) => {
        log('ğŸ“œ CHAT HISTORY: Received ' + data.messages.length + ' messages', 'success');
        data.messages.forEach((msg, index) => {
          log(`  [${index + 1}] ${msg.sender_id}: ${msg.content} (${msg.status})`, 'info');
        });
      });

      socket.on('newMessage', (message) => {
        log('ğŸ“¨ NEW MESSAGE: ' + JSON.stringify(message, null, 2), 'success');
      });

      socket.on('messageSeen', (data) => {
        log('âœ“âœ“ MESSAGE SEEN: ' + JSON.stringify(data, null, 2), 'info');
      });

      socket.on('chatUpdated', (chat) => {
        log('ğŸ”„ CHAT UPDATED: ' + JSON.stringify(chat, null, 2), 'info');
      });

      socket.on('userTyping', (data) => {
        log('âŒ¨ï¸ USER TYPING: User ' + data.user_id + ' in chat ' + data.chat_id, 'warning');
      });

      socket.on('userStopTyping', (data) => {
        log('â¸ï¸ USER STOP TYPING: User ' + data.user_id + ' in chat ' + data.chat_id, 'info');
      });

      socket.on('notification', (data) => {
        log('ğŸ”” NOTIFICATION: ' + JSON.stringify(data, null, 2), 'warning');
      });
    }

    function disconnect() {
      if (socket) {
        socket.disconnect();
        socket = null;
        log('ğŸ”Œ ÄÃ£ ngáº¯t káº¿t ná»‘i', 'info');
        updateStatus(false);
      }
    }

    function joinChat() {
      const chatId = document.getElementById('chatId').value.trim();
      if (!chatId) {
        alert('Vui lÃ²ng nháº­p Chat ID!');
        return;
      }
      
      socket.emit('joinChat', { chat_id: chatId });
      log('â¡ï¸ Emit: joinChat { chat_id: "' + chatId + '" }', 'info');
    }

    function leaveChat() {
      const chatId = document.getElementById('chatId').value.trim();
      if (!chatId) {
        alert('Vui lÃ²ng nháº­p Chat ID!');
        return;
      }
      
      socket.emit('leaveChat', { chat_id: chatId });
      log('â¬…ï¸ Emit: leaveChat { chat_id: "' + chatId + '" }', 'info');
    }

    function sendTyping() {
      const chatId = document.getElementById('chatId').value.trim();
      const userId = document.getElementById('userId').value.trim();
      
      if (!chatId || !userId) {
        alert('Vui lÃ²ng nháº­p Chat ID vÃ  User ID!');
        return;
      }
      
      socket.emit('typing', { chat_id: chatId, user_id: userId });
      log('âŒ¨ï¸ Emit: typing { chat_id: "' + chatId + '", user_id: "' + userId + '" }', 'warning');
    }

    function stopTyping() {
      const chatId = document.getElementById('chatId').value.trim();
      const userId = document.getElementById('userId').value.trim();
      
      if (!chatId || !userId) {
        alert('Vui lÃ²ng nháº­p Chat ID vÃ  User ID!');
        return;
      }
      
      socket.emit('stopTyping', { chat_id: chatId, user_id: userId });
      log('â¸ï¸ Emit: stopTyping { chat_id: "' + chatId + '", user_id: "' + userId + '" }', 'info');
    }

    async function sendMessage() {
      const token = document.getElementById('jwtToken').value.trim();
      const chatId = document.getElementById('chatId').value.trim();
      const userId = document.getElementById('userId').value.trim();
      const content = document.getElementById('messageContent').value.trim();
      
      if (!chatId || !userId || !content) {
        alert('Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ Chat ID, User ID vÃ  ná»™i dung message!');
        return;
      }

      try {
        log('ğŸ“¤ Äang gá»­i message qua REST API...', 'info');
        
        const response = await fetch('http://localhost:3000/api/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            chat_id: chatId,
            sender_id: userId,
            content: content,
            attachments: []
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          log('âœ… Message sent successfully: ' + JSON.stringify(data, null, 2), 'success');
          document.getElementById('messageContent').value = '';
        } else {
          log('âŒ Error sending message: ' + JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        log('âŒ Network error: ' + error.message, 'error');
      }
    }

    function clearLogs() {
      logsDiv.innerHTML = '';
    }

    async function createTestChat() {
      const token = document.getElementById('jwtToken').value.trim();
      const user1Id = document.getElementById('user1Id').value.trim();
      const user2Id = document.getElementById('user2Id').value.trim();
      
      if (!token || !user1Id || !user2Id) {
        alert('Vui lÃ²ng nháº­p JWT token vÃ  cáº£ 2 User IDs!');
        return;
      }

      try {
        log('ğŸ“¤ Äang táº¡o test chat...', 'info');
        
        const response = await fetch('http://localhost:3000/api/chats/private', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            user1_id: user1Id,
            user2_id: user2Id
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          const chatId = data.data._id;
          document.getElementById('chatId').value = chatId;
          document.getElementById('userId').value = user1Id;
          
          log('âœ… Test chat created successfully!', 'success');
          log('Chat ID: ' + chatId, 'success');
          log('ğŸ’¡ BÃ¢y giá» click "Join Chat" Ä‘á»ƒ báº¯t Ä‘áº§u test!', 'warning');
        } else {
          log('âŒ Error creating chat: ' + JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        log('âŒ Network error: ' + error.message, 'error');
      }
    }

    async function cleanupTestData() {
      const token = document.getElementById('jwtToken').value.trim();
      
      if (!token) {
        alert('Vui lÃ²ng nháº­p JWT token!');
        return;
      }

      if (!confirm('âš ï¸ XÃ³a Táº¤T Cáº¢ test chats vÃ  messages cá»§a báº¡n?\n\nLÆ°u Ã½: KhÃ´ng thá»ƒ khÃ´i phá»¥c!')) {
        return;
      }

      try {
        log('ğŸ§¹ Äang dá»n dáº¹p test data...', 'warning');
        
        const response = await fetch('http://localhost:3000/api/chats/test/cleanup', {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();
        
        if (response.ok) {
          log('âœ… Cleanup successful: ' + JSON.stringify(data, null, 2), 'success');
          log('ğŸ’¡ Database Ä‘Ã£ sáº¡ch, cÃ³ thá»ƒ test láº¡i tá»« Ä‘áº§u!', 'success');
          
          // Clear inputs
          document.getElementById('chatId').value = '';
          document.getElementById('userId').value = '';
          document.getElementById('messageContent').value = '';
        } else {
          log('âŒ Error cleaning up: ' + JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        log('âŒ Network error: ' + error.message, 'error');
      }
    }

    async function createPrivateChat() {
      const token = document.getElementById('jwtToken').value.trim();
      const user1Id = document.getElementById('user1Id').value.trim();
      const user2Id = document.getElementById('user2Id').value.trim();
      
      if (!token) {
        alert('Vui lÃ²ng nháº­p JWT token vÃ  Connect trÆ°á»›c!');
        return;
      }
      
      if (!user1Id || !user2Id) {
        alert('Vui lÃ²ng nháº­p cáº£ 2 User IDs!');
        return;
      }

      try {
        log('ğŸ“¤ Äang táº¡o private chat giá»¯a User 1 vÃ  User 2...', 'info');
        
        const response = await fetch('http://localhost:3000/api/chats/private', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            user1_id: user1Id,
            user2_id: user2Id
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          // Backend tráº£ vá» double nested: data.data.data._id (do TransformInterceptor)
          const chatId = data.data?.data?._id || data.data?._id || data._id;
          
          if (!chatId) {
            log('âš ï¸ KhÃ´ng tÃ¬m tháº¥y Chat ID trong response!', 'error');
            log('Response: ' + JSON.stringify(data, null, 2), 'error');
            return;
          }
          
          // Tá»± Ä‘á»™ng Ä‘iá»n vÃ o Ã´ Chat ID vÃ  User ID cho User 1
          document.getElementById('chatId').value = chatId;
          document.getElementById('userId').value = user1Id;
          
          log('âœ… Chat created successfully!', 'success');
          log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
          log('ğŸ“‹ CHAT ID: ' + chatId, 'success');
          log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
          log('', 'info');
          log('ğŸ‘‰ USER 1 (báº¡n): Click "Join Chat" bÃªn dÆ°á»›i ngay!', 'warning');
          log('', 'info');
          log('ğŸ‘‰ USER 2: Copy Chat ID nÃ y vÃ  lÃ m theo:', 'warning');
          log('   1. Paste Chat ID: ' + chatId, 'warning');
          log('   2. Nháº­p User 2 ID vÃ o Ã´ "Your User ID"', 'warning');
          log('   3. Click "Join Chat"', 'warning');
          log('', 'info');
          log('ğŸ‰ Sau Ä‘Ã³ cáº£ 2 users cÃ³ thá»ƒ chat real-time!', 'success');
        } else {
          log('âŒ Error creating chat: ' + JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        log('âŒ Network error: ' + error.message, 'error');
      }
    }

    // Initialize
    updateStatus(false);
    
    // Clear inputs khi load trang
    document.getElementById('chatId').value = '';
    document.getElementById('userId').value = '';
    document.getElementById('user1Id').value = '';
    document.getElementById('user2Id').value = '';
    
    log('ğŸš€ Test Chat WebSocket ready!', 'success');
    log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
    log('ğŸ“– USER 1: Connect â†’ Nháº­p 2 User IDs â†’ Create Chat', 'info');
    log('ğŸ“– USER 2: Connect â†’ Paste Chat ID tá»« User 1 â†’ Join', 'info');
  </script>
</body>
</html>
